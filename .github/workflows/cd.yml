name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build & Push Docker"]
    types: [ "completed" ]
  push:
    branches: [ "main" ]
    paths:
      - 'k8s/**'

permissions:
  contents: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up variables
      id: vars
      run: |
        echo "IMAGE=allanprust/monitor" >> $GITHUB_OUTPUT
        echo "TAG_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        echo "NAMESPACE=${{ secrets.K8S_NAMESPACE || 'default' }}" >> $GITHUB_OUTPUT

    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    - name: Configure kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > $HOME/.kube/config

    - name: Verify cluster access
      run: kubectl cluster-info

    - name: Create namespace if not exists
      run: |
        kubectl get ns ${{ steps.vars.outputs.NAMESPACE }} || \
        kubectl create ns ${{ steps.vars.outputs.NAMESPACE }}

    - name: Apply Kubernetes manifests
      run: |
        echo "Applying all Kubernetes manifests..."
        kubectl apply -n ${{ steps.vars.outputs.NAMESPACE }} -f k8s/ --recursive || true

    - name: Update deployment image
      run: |
        kubectl set image deployment/monitor \
          monitor=${{ steps.vars.outputs.IMAGE }}:latest \
          -n ${{ steps.vars.outputs.NAMESPACE }} \
          --record

    - name: Wait for rollout to complete
      run: |
        kubectl rollout status deployment/monitor \
          -n ${{ steps.vars.outputs.NAMESPACE }} \
          --timeout=180s

    - name: Verify deployment
      run: |
        echo "=== Current Pods ==="
        kubectl get pods -n ${{ steps.vars.outputs.NAMESPACE }} -l app=monitor
        
        echo "=== Current Services ==="
        kubectl get svc -n ${{ steps.vars.outputs.NAMESPACE }}
        
        echo "=== Deployment Status ==="
        kubectl get deployment -n ${{ steps.vars.outputs.NAMESPACE }}

    - name: Health check
      run: |
        echo "Performing health check..."
        kubectl wait --for=condition=ready \
          pod -l app=monitor \
          --timeout=120s \
          -n ${{ steps.vars.outputs.NAMESPACE }}