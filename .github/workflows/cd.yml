name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build & Push Docker"]
    types: [ "completed" ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Minikube
      uses: medyagh/setup-minikube@v1

    - name: Start Minikube cluster
      run: |
        minikube start --driver=docker
        minikube status

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/ --recursive || true

    - name: Update deployment image
      run: |
        kubectl set image deployment/monitor monitor=allanprust/monitor:latest

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/monitor --timeout=180s

    - name: Verify deployment
      run: |
        echo "=== Cluster Info ==="
        kubectl cluster-info
        
        echo "=== Pods ==="
        kubectl get pods -l app=monitor
        
        echo "=== Services ==="
        kubectl get svc
        
        echo "=== Deployments ==="
        kubectl get deployments