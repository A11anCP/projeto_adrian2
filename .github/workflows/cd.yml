name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build & Push Docker"]
    types: [ "completed" ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v4

    - name: Configure kubeconfig
      run: |
        mkdir -p $HOME/.kube
        # MÃ©todo alternativo sem HEREDOC
        echo "apiVersion: v1" > $HOME/.kube/config
        echo "clusters:" >> $HOME/.kube/config
        echo "- cluster:" >> $HOME/.kube/config
        echo "    insecure-skip-tls-verify: true" >> $HOME/.kube/config
        echo "    server: https://127.0.0.1:61201" >> $HOME/.kube/config
        echo "  name: minikube" >> $HOME/.kube/config
        echo "contexts:" >> $HOME/.kube/config
        echo "- context:" >> $HOME/.kube/config
        echo "    cluster: minikube" >> $HOME/.kube/config
        echo "    user: minikube" >> $HOME/.kube/config
        echo "  name: minikube" >> $HOME/.kube/config
        echo "current-context: minikube" >> $HOME/.kube/config
        echo "kind: Config" >> $HOME/.kube/config
        echo "users:" >> $HOME/.kube/config
        echo "- name: minikube" >> $HOME/.kube/config
        echo "  user: {}" >> $HOME/.kube/config
        
        echo "=== Kubeconfig criado ==="
        cat $HOME/.kube/config

    - name: Test cluster access
      run: |
        kubectl config view
        kubectl cluster-info

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/ --recursive || true

    - name: Update deployment image
      run: |
        kubectl set image deployment/monitor monitor=allanprust/monitor:latest

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/monitor --timeout=180s

    - name: Verify deployment
      run: |
        kubectl get pods -l app=monitor
        kubectl get svc