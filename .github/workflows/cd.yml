name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build & Push Docker"]
    types: [ "completed" ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v4

    - name: Configure kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > $HOME/.kube/config
        
        # Validar kubeconfig
        echo "=== Validando kubeconfig ==="
        if kubectl auth can-i get pods &>/dev/null; then
          echo "✅ Autenticação válida"
        else
          echo "❌ Falha na autenticação, tentando abordagem alternativa..."
          # Abordagem alternativa
          kubectl config set-credentials minikube-user --token=dummy-token 2>/dev/null || true
        fi
        
        kubectl config view
        kubectl cluster-info

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/ --recursive || true

    - name: Update deployment image
      run: |
        kubectl set image deployment/monitor monitor=allanprust/monitor:latest

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/monitor --timeout=180s

    - name: Verify deployment
      run: |
        kubectl get pods -l app=monitor
        kubectl get svc