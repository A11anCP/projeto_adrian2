name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build & Push Docker"]
    types: ["completed"]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v4

    # âš™ï¸ ConfiguraÃ§Ã£o do kubeconfig (decodifica o segredo Base64)
    - name: Configure kubeconfig from secret
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
        echo "âœ… Kubeconfig configurado com sucesso"
        kubectl config current-context || echo "âš ï¸ Nenhum contexto atual definido (verifique o kubeconfig)"

    # ğŸ§ª Testar conexÃ£o com o cluster
    - name: Test cluster access
      run: |
        echo "ğŸ” Verificando cluster..."
        kubectl cluster-info
        kubectl get nodes

    # ğŸš€ Aplicar manifestos Kubernetes
    - name: Apply Kubernetes manifests
      run: |
        echo "ğŸ“¦ Aplicando manifestos..."
        kubectl apply -f k8s/ --recursive

    # ğŸ–¼ï¸ Atualizar a imagem do deployment
    - name: Update deployment image
      run: |
        echo "ğŸ–¼ï¸ Atualizando imagem do deployment..."
        kubectl set image deployment/monitor monitor=allanprust/monitor:latest

    # â±ï¸ Aguardar rollout
    - name: Wait for rollout
      run: |
        echo "â³ Aguardando rollout..."
        kubectl rollout status deployment/monitor --timeout=180s

    # ğŸ” Verificar pods e serviÃ§os
    - name: Verify deployment
      run: |
        echo "ğŸ” Verificando pods e serviÃ§os..."
        kubectl get pods -l app=monitor
        kubectl get svc
